name: Health Check
on:
  workflow_call:
    inputs:
      channel-id:
        description: "Slack channel-id to post notification to"
        required: false
        type: string
        default: NO_ID

jobs:
  # See if there are dependabot PRs that are open, so we can notify that they need attention.
  dependabot-open-pr-check:
    runs-on: ubuntu-24.04
    outputs:
      message: ${{ steps.evaluate.outputs.message }}
    steps:
      - uses: actions/checkout@v4
      - name: Dependabot branch count
        id: count
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "major=`gh pr list --state open | grep dependabot | grep "minor-patch" | wc -l | xargs`" >> $GITHUB_OUTPUT
          echo "minpatch=`gh pr list --state open | grep dependabot | grep "major-updates" | wc -l | xargs`" >> $GITHUB_OUTPUT

      - name: Evaluate dependabot results
        id: evaluate
        shell: python
        env:
          MAJOR: ${{ steps.count.outputs.major }}
          MINOR_PATCH: ${{ steps.count.outputs.minpatch }}
          REPOS: ${{ github.repository }}
        run: |
          import os
          import time

          repository = os.environ['REPOS']
          major = int(os.environ['MAJOR'])
          minpatch = int(os.environ['MINOR_PATCH'])

          slack = (f'❕ Open dependabot PRs for {repository} major: {major}, minor / patch: {minpatch}'
                    if major > 0 or minpatch > 0 else
                  'no_message')

          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
              print(f'message={slack}', file=fh)

  post-dependabot-health:
    needs: dependabot-open-pr-check
    if: success() && !contains(needs.dependabot-open-pr-check.outputs.message,'no_message') && inputs.channel-id != 'NO_ID'
    uses: entur/gha-slack/.github/workflows/post.yml@v2
    with:
      channel_id: ${{ inputs.channel-id }}
      message: "${{ needs.health-check.outputs.message }}"
    secrets: inherit

  check-stale-and-merged-branches:
    runs-on: ubuntu-24.04
    outputs:
      message: ${{ steps.evaluate.outputs.message }}
    steps:
      - uses: actions/checkout@v4
      - name: Dependabot branch count
        id: evaluate
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $stale=0
          foreach ($line in @(git branch -r --no-merge | grep -v HEAD)) {
            $dateline += git log --no-merges -n 1 --format="%ci, %cr, %an, %ae, " $line.strip
            # This will not count stale branches that are "x years and 0 or 1 month", but that
            # is acceptable for the usage here, you are warned for 10 months, what is 2 without...
            if ($dateline -contains "day") {
              $stale++
            }
          }

          $merged = @( git branch -r --merged ).length

          if ($merged -gt 0 -or $stale -gt -0) {
            echo "message=has $merged merged branches and $stale stale branches, please tidy up" >> $env:GITHUB_OUTPUT
          } else {
            echo "message=no_message" >> $env:GITHUB_OUTPUT
          }

  post-to-slack:
    needs: check-stale-and-merged-branches
    if: success() && !contains(needs.check-stale-and-merged-branches.outputs.message,'no_message') && inputs.channel-id != 'NO_ID'
    uses: entur/gha-slack/.github/workflows/post.yml@v2
    with:
      channel_id: ${{ inputs.channel-id }}
      message: "❕ ${{ github.repository }} ${{ needs.check-stale-and-merged-branches.outputs.message }}"
    secrets: inherit

  post-failure-to-slack:
    needs: check-stale-and-merged-branches
    if: failure() && inputs.channel-id != 'NO_ID'
    uses: entur/gha-slack/.github/workflows/post.yml@v2
    with:
      channel_id: ${{ inputs.channel-id }}
      message: "🔴 ${{ github.repository }} - Failed running health check job.\n ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
    secrets: inherit
